<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
<h1>Dashboard</h1>

<div>
    <label for="posX">Position X:</label>
    <input type="text" id="posX" placeholder="Enter X coordinate">
</div>
<div>
    <label for="posY">Position Y:</label>
    <input type="text" id="posY" placeholder="Enter Y coordinate">
</div>
<div>
    <label for="hour">Hour:</label>
    <input type="text" id="hour" placeholder="Enter hour">
</div>
<div>
    <label for="day">Day of the Week (Numeric):</label>
    <input type="text" id="day" placeholder="Enter day">
</div>
<button onclick="showMap()">Show Map</button>

<div id="map"></div>

<script>

    // Création de la carte du monde avec Plotly au chargement de la page
    document.addEventListener('DOMContentLoaded', function () {
        var layout = {
            mapbox: {
                style: 'mapbox://styles/mapbox/light-v10',
                center: { lon: 0, lat: 0 },
                zoom: 10
            },
            margin: { t: 0, b: 0 }
        };

        var config = {
            mapboxAccessToken: 'pk.eyJ1Ijoia3lyYXM5NzQiLCJhIjoiY2xwY2Z0N2FiMHA4YjJqcXQ4dDh3YTU4ZSJ9.FkduOcz9ngx4VnbaqewIvA'
        };

        Plotly.newPlot('map', [
            {
                type: 'scattermapbox',
                mode: 'markers+text',
                text: [],
                lon: [],
                lat: [],
                marker: {
                    size: 10,
                    color: [
                        '#ff0202',
                    ],
                },
                name: 'Crime',
                textposition: [
                    'top right', 'top left', 'top center', 'bottom right', 'top right',
                    'top left', 'bottom right', 'bottom left', 'top right', 'top right'
                ],
            }
        ], layout, config);
    });

    function generateText(data) {
        let categories = {
            'Person Crimes': ['OTHER OFFENSES', 'ASSAULT', 'RUNAWAY', 'KIDNAPPING','SUICIDE'],
            'Property Crimes': ['LARCENY/THEFT', 'VEHICLE THEFT', 'BURGLARY', 'STOLEN PROPERTY', 'RECOVERED VEHICLE', 'TRESPASS'],
            'Sexual Crimes': ['PROSTITUTION', 'SEX OFFENSES FORCIBLE', 'SEX OFFENSES NON FORCIBLE','PORNOGRAPHY/OBSCENE MAT','SEX OFFENSES FORCIBLE', 'SEX OFFENSES NON FORCIBLE',],
            'Financial Crimes': ['FRAUD', 'BRIBERY', 'EMBEZZLEMENT', 'BAD CHECKS','FORGERY/COUNTERFEITING','EXTORTION'],
            'Depencense Crimes': ['DRUNKENNESS', 'LIQUOR LAWS', 'DRIVING UNDER THE INFLUENCE','DRUG/NARCOTIC', 'DRUNKENNESS', 'LIQUOR LAWS'],
            'Vehicle Crimes': ['DRIVING UNDER THE INFLUENCE', 'VEHICLE THEFT', 'RECOVERED VEHICLE','DISORDERLY CONDUCT'],
            'Family Crimes': ['FAMILY OFFENSES', 'MISSING PERSON', 'RUNAWAY', 'FAMILY OFFENSES', 'MISSING PERSON'],
            'Society Crimes': ['VANDALISM',  'ROBBERY', 'WEAPON LAWS',  'ARSON','LOITERING',  'GAMBLING'],
            'Miscellaneous':['SUSPICIOUS OCC', 'SECONDARY CODES', 'TREA','NON-CRIMINAL','WARRANTS']
        }

        var text = ''

        for (const [index, [category, items]] of Object.entries(categories).entries()) {
            text = `${text}` + '        ' + `${category} : ${data[index]}`;
        }
        return text
    }

    // Fonction pour ajouter un point à la carte lors du clic sur le bouton
    async function showMap() {
        const posX = parseFloat(document.getElementById('posX').value);
        const posY = parseFloat(document.getElementById('posY').value);
        const hour = parseFloat(document.getElementById('hour').value);
        const day = parseFloat(document.getElementById('day').value);

        try {
            const response = await fetch('http://127.0.0.1:8000/predictM', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    dayOfWeek: day,
                    x: posX,
                    y: posY,
                    hour: hour,
                })
            });

            if (!response.ok) {
                throw new Error('Failed to fetch data');
            }

            const responseData = await response.json();
            const percentages = responseData.map(value => (value * 100).toFixed(2));
            console.log(generateText(percentages))
            var update = {
                type: 'scattermapbox',
                mode: 'markers+text',
                text: [generateText(percentages)],
                lon: [[posX]],
                lat: [[posY]],
                marker: {
                    size: 5,
                    color: [
                        '#ff0202',
                    ],
                },
                name: 'Crime',
                textposition: [
                    'top right', 'top left', 'top center', 'bottom right', 'top right',
                    'top left', 'bottom right', 'bottom left', 'top right', 'top right'
                ],
            };

            Plotly.update('map', update);
        } catch (error) {
            console.error('Error:', error);
        }
    }
</script>
</body>
</html>
